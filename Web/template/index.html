{% extends '__head.html' %}
{% load widget_tweaks %}

{% block body %}
<div class="ui stackable grid">
    <div class="four wide column">
        <div class="ui segment">
            <h4 class="ui header">
                {% if user.display_name %}{{ user.display_name }}{% else %}{{ user.username }}{% endif %}
                <div class="header sub"><a href="{% url 'UserShow' user.username %}">@{{ user.username }}</a></div>
            </h4>
        </div>
        <div class="ui segment">
            <form method="POST" action="{% url 'NewPost' %}" id="newPostFormIndex" name="newPostFormIndex" class="ui form" onsubmit="newPostIndex();return false;">
                {% for field in NewPostForm_ %}
                    <div class="field">
                        <label>{{ field.name }}</label>
                        {{ field|add_class:"enableShortcutKey" }}
                    </div>
                {% endfor %}
                {% csrf_token %}
                <button type="submit" class="ui button fluid primary" id="postIndexSubmit">投稿</button>
            </form>
        </div>
    </div>
    <div class="twelve wide column">
        {% for posts in timeline %}
        <div class="ui top attached segment" id="{{ posts.uuid }}">
            <h4 class="ui header">
                {% if posts.parent %}
                {% if posts.parent.display_name %}{{ posts.parent.display_name }}{% else %}{{ posts.parent.username }}{% endif %}
                {% elif posts.parentFedi %}
                {% if posts.parentFedi.display_name %}{{ posts.parentFedi.display_name }}{% else %}{{ posts.parentFedi.username }}{% endif %}
                {% endif %}
                <div class="sub header">
                    {% if posts.parent %}
                    @{{ posts.parent.username }}
                    {% elif posts.parentFedi %}
                    @{{ posts.parentFedi.username }}@{{ posts.parentFedi.Host }}
                    {% endif %}
                </div>
                <small>{{ posts.posted }}</small>
            </h4>
            <div class="post">
                {% if not posts.announceTo %}
                {{ posts.body|safe }}
                {% else %}
                <div class="ui small feed">
                    <div class="event">
                        <div class="content">
                            <div class="summary">
                                {% if posts.parent %}
                                {% if posts.parent.display_name %}{{ posts.parent.display_name }}{% else %}{{ posts.parent.username }}{% endif %}
                                {% elif posts.parentFedi %}
                                {% if posts.parentFedi.display_name %}{{ posts.parentFedi.display_name }}{% else %}{{ posts.parentFedi.username }}{% endif %}
                                {% endif %}
                                がアナウンス
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ui segment">
                    <h4 class="ui header">
                        {% if posts.announceTo.parent %}
                        {% if posts.announceTo.parent.display_name %}{{ posts.announceTo.parent.display_name }}{% else %}{{ posts.announceTo.parent.username }}{% endif %}
                        {% elif posts.announceTo.parentFedi %}
                        {% if posts.announceTo.parentFedi.display_name %}{{ posts.announceTo.parentFedi.display_name }}{% else %}{{ posts.announceTo.parentFedi.username }}{% endif %}
                        {% endif %}
                        <div class="sub header">
                            {% if posts.announceTo.parent %}
                            <a href="{% url 'UserShow' posts.announceTo.parent.username %}">@{{ posts.announceTo.parent.username }}</a>
                            {% elif posts.announceTo.parentFedi %}
                            <a href="{% url 'FediUserShow' posts.announceTo.parentFedi.username posts.announceTo.parentFedi.Host %}">@{{ posts.announceTo.parentFedi.username }}@{{ posts.announceTo.parentFedi.Host }}</a>
                            {% endif %}
                        </div>
                    </h4>
                    <div>
                        {{ posts.announceTo.body|safe }}
                    </div>
                    <small>{{ posts.announceTo.postsed }}</small>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="ui bottom attached menu">
            <a class="ui icon item link" href="{% url 'PostDetail' posts.uuid %}" title="詳細を表示">
                <i class="linkify icon"></i>
            </a>
            {% if user.is_authenticated %}
            <a class="ui icon item link" onclick="announce('{{ posts.uuid }}')" title="アナウンス">
                <i class="retweet icon"></i>
            </a>
            <a class="ui icon item link" onclick="favorite('{{ posts.uuid }}')" title="お気に入り">
                <i class="star icon"></i>
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block script %}
<script>
function newPostIndex () {
    $('#postIndexSubmit').addClass("disabled loading")
    var postFormValue = $('#newPostFormIndex').serialize()
    var postTarget = $('#newPostFormIndex').attr('action')
    $.post(postTarget, postFormValue)
        .done(function (data) {
            console.info("Post complete!")
            console.info(data)
            $('#newPostFormIndex')[0].reset()
            $.uiAlert({
                textHead: '投稿に成功しました。',
                text: '',
                bgcolor: '#19c3aa',
                textcolor: '#fff',
                position: 'bottom-left',
                icon: 'checkmark box',
                time: 3,
            })
        })
        .fail(function (jqXHR) {
            try {
            var res = JSON.parse(jqXHR.responseText)
            console.error("Post failed!: " + res.error.msg)
            $.uiAlert({
                textHead: '投稿できません。',
                text: res.error.msg,
                bgcolor: '#DB2828',
                textcolor: '#fff',
                position: 'bottom-left',
                icon: 'remove circle',
                time: 5,
            })
            } catch (error) {
            $.uiAlert({
                textHead: '投稿できません。',
                text: '不明なエラー',
                bgcolor: '#DB2828',
                textcolor: '#fff',
                position: 'bottom-left',
                icon: 'remove circle',
                time: 5,
            })
            }
        })
        .always(function () {
            $('#postIndexSubmit').removeClass("disabled loading")
        })
}
</script>
{% endblock %}
